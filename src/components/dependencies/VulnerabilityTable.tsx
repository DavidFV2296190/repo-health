"use client";

import { useState, useMemo } from "react";
import {
  Box,
  Flex,
  Input,
  Text,
  Table,
  Badge,
  Button,
  HStack,
} from "@chakra-ui/react";
import { FaExternalLinkAlt, FaSearch } from "react-icons/fa";

type Severity = "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";

type Vulnerability = {
  id: string;
  severity: Severity;
  summary: string;
  fixedVersion?: string;
};

type VulnerabilityWithPackage = Vulnerability & {
  packageName: string;
  packageVersion: string;
};

type Props = {
  vulnerabilities: VulnerabilityWithPackage[];
  selectedId?: string;
  onSelect?: (vuln: VulnerabilityWithPackage) => void;
};

const SEVERITY_COLORS: Record<Severity, string> = {
  CRITICAL: "#f85149",
  HIGH: "#db6d28",
  MEDIUM: "#d29922",
  LOW: "#238636",
};

const SEVERITY_ORDER: Severity[] = ["CRITICAL", "HIGH", "MEDIUM", "LOW"];

function SeverityBadge({ severity }: { severity: Severity }) {
  return (
    <Badge
      bg={SEVERITY_COLORS[severity]}
      color="white"
      px={2}
      py={1}
      borderRadius="md"
      fontSize="xs"
    >
      {severity}
    </Badge>
  );
}

function SeverityFilterButton({
  severity,
  isActive,
  count,
  onClick,
}: {
  severity: Severity;
  isActive: boolean;
  count: number;
  onClick: () => void;
}) {
  return (
    <Button
      size="xs"
      onClick={onClick}
      bg={isActive ? SEVERITY_COLORS[severity] : "transparent"}
      color={isActive ? "white" : SEVERITY_COLORS[severity]}
      border="1px solid"
      borderColor={SEVERITY_COLORS[severity]}
      _hover={{
        bg: isActive
          ? SEVERITY_COLORS[severity]
          : `${SEVERITY_COLORS[severity]}20`,
      }}
      opacity={isActive ? 1 : 0.7}
    >
      {severity} ({count})
    </Button>
  );
}

export function VulnerabilityTable({
  vulnerabilities,
  selectedId,
  onSelect,
}: Props) {
  const [searchTerm, setSearchTerm] = useState("");
  const [activeSeverities, setActiveSeverities] = useState<Set<Severity>>(
    new Set(SEVERITY_ORDER)
  );

  // Count of each severity
  const severityCounts = useMemo(() => {
    const counts: Record<Severity, number> = {
      CRITICAL: 0,
      HIGH: 0,
      MEDIUM: 0,
      LOW: 0,
    };
    vulnerabilities.forEach((v) => counts[v.severity]++);
    return counts;
  }, [vulnerabilities]);

  // Toggle a severity filter
  const toggleSeverity = (severity: Severity) => {
    setActiveSeverities((prev) => {
      const next = new Set(prev);
      if (next.has(severity)) {
        next.delete(severity);
      } else {
        next.add(severity);
      }
      return next;
    });
  };

  // Filter vulnerabilities based on severity + search term
  const filteredVulnerabilities = useMemo(() => {
    return vulnerabilities.filter((vuln) => {
      // First check severity filter
      if (!activeSeverities.has(vuln.severity)) return false;

      // Then check text search (package, ID, summary only)
      if (!searchTerm.trim()) return true;

      const term = searchTerm.toLowerCase();
      return (
        vuln.packageName.toLowerCase().includes(term) ||
        vuln.id.toLowerCase().includes(term) ||
        vuln.summary.toLowerCase().includes(term)
      );
    });
  }, [vulnerabilities, activeSeverities, searchTerm]);

  return (
    <Box>
      {/* Header with title */}
      <Flex justify="space-between" align="center" mb={3}>
        <Text fontSize="xl" fontWeight="bold" color="#c9d1d9">
          Vulnerabilities ({filteredVulnerabilities.length}/
          {vulnerabilities.length})
        </Text>
        <Box position="relative">
          <Input
            placeholder="Search package, ID, or summary..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            w="280px"
            pl={9}
            size="sm"
            bg="#0d1117"
            border="1px solid #30363d"
            color="#c9d1d9"
            _placeholder={{ color: "#6e7681" }}
            _focus={{ borderColor: "#58a6ff" }}
          />
          <Box
            position="absolute"
            left={3}
            top="50%"
            transform="translateY(-50%)"
          >
            <FaSearch color="#6e7681" size={12} />
          </Box>
        </Box>
      </Flex>

      {/* Severity Filter Buttons */}
      <HStack gap={2} mb={4}>
        <Text fontSize="sm" color="#8b949e">
          Filter:
        </Text>
        {SEVERITY_ORDER.map((severity) => (
          <SeverityFilterButton
            key={severity}
            severity={severity}
            isActive={activeSeverities.has(severity)}
            count={severityCounts[severity]}
            onClick={() => toggleSeverity(severity)}
          />
        ))}
      </HStack>

      {/* Table */}
      <Box overflowX="auto" borderRadius="lg" border="1px solid #30363d">
        <Table.Root size="sm">
          <Table.Header>
            <Table.Row bg="#161b22">
              <Table.ColumnHeader
                color="#8b949e"
                borderColor="#30363d"
                w="85px"
              >
                Severity
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                Package
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                ID
              </Table.ColumnHeader>
              <Table.ColumnHeader color="#8b949e" borderColor="#30363d">
                Summary
              </Table.ColumnHeader>
              <Table.ColumnHeader
                color="#8b949e"
                borderColor="#30363d"
                w="70px"
              >
                Fix
              </Table.ColumnHeader>
              <Table.ColumnHeader
                color="#8b949e"
                borderColor="#30363d"
                w="50px"
              ></Table.ColumnHeader>
            </Table.Row>
          </Table.Header>
          <Table.Body>
            {filteredVulnerabilities.map((vuln, idx) => (
              <Table.Row
                key={`${vuln.id}-${idx}`}
                bg={selectedId === vuln.id ? "#21262d" : "#0d1117"}
                _hover={{ bg: "#21262d" }}
                transition="background 0.2s"
                cursor="pointer"
                onClick={() => onSelect?.(vuln)}
              >
                <Table.Cell borderColor="#30363d" w="85px">
                  <SeverityBadge severity={vuln.severity} />
                </Table.Cell>
                <Table.Cell
                  borderColor="#30363d"
                  fontFamily="mono"
                  fontSize="xs"
                >
                  <Text color="#c9d1d9" fontSize="xs">
                    {vuln.packageName}
                  </Text>
                  <Text color="#6e7681" fontSize="xs">
                    @{vuln.packageVersion}
                  </Text>
                </Table.Cell>
                <Table.Cell
                  borderColor="#30363d"
                  color="#58a6ff"
                  fontFamily="mono"
                  fontSize="xs"
                >
                  {vuln.id}
                </Table.Cell>
                <Table.Cell borderColor="#30363d" color="#8b949e" fontSize="xs">
                  {vuln.summary}
                </Table.Cell>
                <Table.Cell
                  borderColor="#30363d"
                  color="#238636"
                  fontFamily="mono"
                  fontSize="sm"
                >
                  {vuln.fixedVersion || "-"}
                </Table.Cell>
                <Table.Cell borderColor="#30363d">
                  <HStack gap={2}>
                    <a
                      href={`https://osv.dev/vulnerability/${vuln.id}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <Button
                        size="xs"
                        variant="outline"
                        borderColor="#30363d"
                        color="#8b949e"
                        _hover={{ bg: "#21262d", color: "#c9d1d9" }}
                      >
                        <FaExternalLinkAlt />
                      </Button>
                    </a>
                  </HStack>
                </Table.Cell>
              </Table.Row>
            ))}
          </Table.Body>
        </Table.Root>
      </Box>
    </Box>
  );
}
